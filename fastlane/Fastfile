
PROJECT_NAME = "Qonversion"
PROJECT_SCHEME = "Sample"
XCODE_PROJECT = "./#{PROJECT_NAME}.xcodeproj"

lane :tests do
  runTests("QonversionTests")
end

lane :integration_tests do
  runTests("IntegrationTests")
end

lane :patch do
  tag = get_tag
  new_version = calculate_patch_version(tag)
  new_tag = "prerelease/" + new_version
  push_tag(new_tag)
end

lane :minor do
  tag = get_tag
  new_version = calculate_minor_version(tag)
  new_tag = "prerelease/" + new_version
  push_tag(new_tag)
end

lane :set_outager_url do |options|
  url = options[:url]
  UI.message("Setting outager URL: #{url}")

  path = Dir['../**/QNOutagerIntegrationTests.m'].first
  UI.message("Target file: #{path}")
  
  # Check file size before update
  file_size_before = File.size(path)
  UI.message("File size before update: #{file_size_before} bytes")
  
  regex = /\<paste outager link here\>/
  
  # Count occurrences before replacement
  file_content = File.read(path)
  occurrences_before = file_content.scan(regex).length
  UI.message("Found #{occurrences_before} placeholder(s) to replace")

  update_file(path, regex, url)
  
  # Check file size after update
  file_size_after = File.size(path)
  UI.message("File size after update: #{file_size_after} bytes")
  
  # Verify replacement
  updated_content = File.read(path)
  occurrences_after = updated_content.scan(regex).length
  replacements_made = occurrences_before - occurrences_after
  
  if replacements_made > 0
    UI.success("Successfully replaced #{replacements_made} placeholder(s) with URL: #{url}")
  else
    UI.error("No replacements were made. Check if placeholder exists in file.")
  end
end

lane :bump do |options|
  new_version = options[:version]

  update_plist(
    plist_path: "Framework/Info.plist",
    block: proc do |plist|
      plist[:CFBundleShortVersionString] = new_version
    end
  )

  version_bump_podspec(
    path: "Qonversion.podspec", 
    version_number: new_version
  )

  file_path = Dir['../**/QONConfiguration.m'].first
  update_file(file_path, /NSString \*const kSDKVersion = @".*";/, "NSString *const kSDKVersion = @\"#{new_version}\";")
end

def get_tag
  tag = last_git_tag()
  result_tag = tag.scan(%r{\d{1,2}.\d{1,2}.\d{1,3}}).first
  return result_tag
end

def calculate_minor_version(tag)
  major, minor, patch = parse_versions(tag)
  new_minor_version = minor.to_i.next.to_s
  new_version = major + "." + new_minor_version + "." + "0"
  return new_version
end

def calculate_patch_version(tag)
  major, minor, patch = parse_versions(tag)
  new_patch_version = patch.to_i.next.to_s
  new_version = major + "." + minor + "." + new_patch_version

  return new_version
end

def push_tag(tag)
  system("git checkout develop")
  system("git pull origin develop")
  add_git_tag(tag: tag)
  push_git_tags(tag: tag)
end

def parse_versions(tag)
  split_version_array = tag.split(".", 3)

  if split_version_array.length == 3
    major = split_version_array[0]
    minor = split_version_array[1]
    patch = split_version_array[2]
      
    return major, minor, patch
  end
end

def update_file(path, regex, result_value)
  file = File.read(path)
  new_content = file.gsub(regex, result_value)
  File.open(path, 'w') { |line| line.puts new_content }
end

def runTests(suite)
  # Увеличиваем таймауты для xcodebuild
  ENV['FASTLANE_XCODEBUILD_SETTINGS_TIMEOUT'] = '10'
  ENV['FASTLANE_XCODEBUILD_SETTINGS_RETRIES'] = '6'
  
  cocoapods(
    repo_update: false,
    podfile: "./Podfile"
  )

  run_tests(
    workspace: "./#{PROJECT_NAME}.xcworkspace",
    scheme: PROJECT_SCHEME,
    only_testing: suite,
    # destination: "platform=iOS Simulator,OS=18.4,name=iPhone 16 Pro",
    xcargs: "CODE_SIGN_IDENTITY='' CODE_SIGNING_REQUIRED=NO CODE_SIGNING_ALLOWED=NO -allowProvisioningUpdates -allowProvisioningDeviceRegistration"
  )
end
